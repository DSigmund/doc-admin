<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
  "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">


<!-- $Id: email.xml,v 1.10 2011-04-04 08:03:20 mg Exp $ -->
<chapter id="email">
<title>Отправка / получение электронной почты</title>

<section id="email-sending">
<title>Отправка почты</title>

<section id="email-sending-sendmail">
<title>через Sendmail (по умолчанию)</title>

<para>
OTRS может отправлять сообщения электронной почты через Sendmail (e.g.
<ulink url="http://www.sendmail.org/">Sendmail</ulink>, <ulink
url="http://www.postfix.org/">Postfix</ulink>, <ulink
url="http://www.qmail.org">Qmail</ulink> or <ulink
url="http://www.exim.org">Exim</ulink>).  Конфигурация по умолчанию
позволяет использовать Sendmail и должны работать при установки системы "из
коробки".
</para>

<para>
Параметры sendmail можно настроить через графический веб-интерфейс для
конфигурации (Framework::Core::Sendmail)
</para>

</section>

<section id="email-sending-smtp">
<title>Через SMTP-сервер или smarthost</title>

<para>
OTRS может отсылать сообщения электронной почты через SMTP ( <ulink
url="http://www.ietf.org/rfc/rfc821.txt">Simple Mail Transfer Protocol / RFC
821</ulink>) или Secure SMTP. Возможно вы захотите использовать эту опцию на
не-unix-системах (например на Windows).
</para>

<para>
Параметры настройки SMTP-сервера могут быть отконфигурированны через
SysConfig (Framework::Core::Sendmail). Если вы не видите SMTPS в качестве
опции, значит вы пропустили установку соответствующих Perl-модулей. В таком
случае, обратитесь пожалуйста к этой <link
linkend="installation-of-perl-modules">"Установка Perl-модулей необходимых
для работы OTRS"</link> инструкции.</para>

</section>

</section>


<section id="email-receiving">
<title>Получение сообщений электронной почты</title>

<section id="email-receiving-pop3">
<title>Учетные записи электронной почты настраиваемые через графический
пользовательский интерфейс OTRS</title>

<para>
OTRS позволяет получать сообщения электронной почты через почтовые аккаунты
POP3, POP3S, IMAP, и IMAPS.
</para>

<para>
Настройка ваших почтовых аккаунтов по ссылке "Почтовые Аккаунты PostMaster"
в панели управления администратора.
</para>

<para>
Если создан новый почтовый аккаунт/ящик (см. ниже Рисунок 7.1), то еще нужно
указать имя его почтового сервера, логин и пароль. Также, вам необходимо
выбрать тип почтового сервера POP3, POP3S, IMAP или IMAPS. Если вы не видите
типа сервера, который хотели бы использовать, значит вы не установили один
из Perl-модулей. В таком случае обратитесь к инструкции <link
linkend="installation-of-perl-modules"> "Installation of Perl modules
required for OTRS" </link> за более подробной информацией.</para>

<para>
<screenshot>
<screeninfo>Добавление учетной записи электронной почты</screeninfo> <graphic srccredit="Adminarea
postmaster - screenshot" scale="40"
fileref="screenshots/add-mailaccount.png"></graphic></screenshot>
</para>

<para>
    <emphasis>Рисунок 7.1. Добавление учетной записи электронной
почты.</emphasis>
</para>

<para>Если вы выбрали "Да" для "Trusted", любые X-OTRS-заголовки присоединенные к
входящему сообщению будут оцениватся и выполнятся. Поскольку
X-OTRS-заголовок может выполнять некоторые действия в системе обработки
заявок, вы должны установить "Trusted" только в "Да" для извесных
отправителей. X-OTRS-заголовки которые используюся <link
linkend="adminarea-postmasterfilter"> модуль фильтрации </link> в
OTRS. Заголовки X-OTRS более подробно рассматриваются в <link
linkend="table-of-x-otrs-headers"> этой таблице </link>. Любые правила
фильтрации которые вы создали и выполнили даже если параметр "Trusted"
установлен в "Да".
</para>

<para>
Распределение входящих сообщений может контролироватся в случае если они
должны сортироватся по очередях или содержимому поля "Кому". Если
"Координация по выбраной очереди" выбранная для "Координации", все входящие
сообщения будут отсортированы в указаной очереди. Адрес, по которому письмо
было отправлено не учитывается в данном случае. Если выбрана опция
"Координация по емейлу"  в поле "Кому": система проверяет связана ли очередь
с адресом эллектронной почты в поле "Кому" для входящих сообщений. Вы можете
связать определенный адрес в <link linkend="adminarea-emailaddresses">
Управление E-mail-адресами</link> в панели управления. Если адрес в поле
"Кому" связан с очередью то новые входящие сообщения будут сохранятся в этой
связанной очереди. Если не найдено никакой связи между адресом в поле "Кому"
то сообщение будет сохранятся в "Raw" очереди в системе, которые есть <link
linkend="Ticket:Core::PostMaster:PostmasterDefaultQueue">
PostmasterDefaultQueue </link> после установки по умолчанию.
</para>

<para>
Все данные для учетных записей электронной почты сохраняются в базе данных
OTRS. Скрипт <filename>otrs.PostMasterMailbox.pl</filename>, который
находится в директории <filename>bin</filename> вашей системы OTRS,
использует настройки в базе данных и получает почту. Вы можете выполнить
файл <filename>./bin/otrs.PostMasterMailbox.pl</filename> вручную чтобы
проверить что все ваши настройки почты работают правильно.
</para>

<para>
Для обычной установки, выборка будет выполнятся каждые 10 минут с помощью
файла заданий <filename>postmaster_mailbox</filename>. Для получения
дополнительной информации об изменении заданий планировщика задач,
обратитесь к главе <link linkend="cronjobs"> cron jobs </link>r.
</para>

<note>
<para>
При получении почты OTRS удаляет почту с POP или IMAP сервера. Там нет опции
также сохранить копию на сервере. Если вы хотите, достичь этого, вы,
вероятно, лучше всего создавать правила переадресации на почтовый
сервер. Пожалуйста, обратитесь к почтовому серверу документации.
</para>
</note>
</section>


<section id="email-receiving-cmd">
<title>Через командную строку программы и например, procmail (otrs.PostMaster.pl)</title>

<para>
Если вы не можете использовать учетные записи для получения электронной
почты в OTRS, программа командной строки
<filename>bin/otrs.PostMaster.pl</filename> это может быть решено. Он
принимает сообщения электронной почты через STDIN и направляет их
непосредственно в OTRS. Это значит что емейлы будут доступны в вашей системе
OTRS если MDA (Mail Delivery Agent - Агент доставки почты) выполняет эту
программу.
</para>

<para>
Для тестирования <filename>bin/otrs.PostMaster.pl</filename> без MDA,
выполните команду приведенную в листинге Сценария 7.1.
</para>

<para>
<screen>
linux:/opt/otrs# cd bin
linux:/opt/otrs/bin# cat ../doc/sample_mails/test-email-1.box | ./otrs.PostMaster.pl
linux:/opt/otrs/bin#
</screen>
</para>

<para>
    <emphasis>Сценарий 7.1. Тестирование PostMaster без MDA.</emphasis>
</para>

<para>
Если сообщения электронной почты отображаются в QueueView, значит вашы
настройки работают.
</para>

<para>
Procmail - это очень распостраненный фильтр электронной почты в среде
Linux.  Он устанавливается на большинстве систем. Если нет, то перейдите по
ссылке <ulink url="http://www.procmail.org/"><citetitle>procmail
homepage</citetitle></ulink>.
</para>

<para>
Для конфигурации procmail для OTRS (требуется сконфигурированный
транспортный агент MTA, например sendmail, postfix, exim or qmail),
используйте файл <filename>~otrs/.procmailrc.dist</filename> и скопируйте
его в <filename>.procmailrc</filename> а затем добавьте строки приведенные в
Сценарии 7.2.
</para>

<para>
<programlisting>
SYS_HOME=$HOME
PATH=/bin:/usr/bin:/usr/local/bin
# --
# Pipe all email into the PostMaster process.
# --
:0 :
| $SYS_HOME/bin/otrs.PostMaster.pl
</programlisting>
</para>

<para>
    <emphasis>Сценарий 7.2. Настройка procmail для OTRS.</emphasis>
</para>

<para>
Все емейлы отсылаемые локальному OTRS-пользователю будут обрабатываться
<filename>bin/otrs.PostMaster.pl</filename> и потом отображаться в
QueueView.
</para>

</section>


<section id="email-receiving-fetchmail">
<title>Получение электронной почты по протоколу POP3 или IMAP и обработка для
otrs.PostMaster.pl</title>

<para>
Для того чтобы получить электронную почту с вашего почтового сервера через
POP3 или IMAP и сохранить ее на компьютере на котором установлен OTRS, для
локального аккаунта или в procmail, перейдите по ссылке <ulink
url="http://fetchmail.berlios.de/">fetchmail</ulink>.
</para>

<note>
<para>
Работающий и сконфигурированный SMTP необходим для работы OTRS.
</para>
</note>

<para>
Вы можете использовать файл <filename>.fetchmailrc.dist</filename> в
домашней директории OTRS и скопировать его в
<filename>.fetchmailrc</filename>. Изменить его в соответствии с вашими
требованиями (см. ниже Пример 7-1).
</para>

<example id='fetchmailrc'>
<title>.fetchmailrc</title>

<para>
<programlisting>
#poll (mailserver) protocol POP3 user (user) password (password) is (localuser)
poll mail.example.com protocol POP3 user joe password mama is otrs
</programlisting>
</para>

</example>

<para>
Не забудьте установить.fetchmailrc to 710 ("chmod 710 .fetchmailrc")!
</para>

<para>
Из Листинга 7-1 выше, <filename>.fetchmailrc</filename> , все емейлы будут
перенаправлены в локальный OTRS-аккаунт, если выполнена команда
<command>fetchmail -a</command>. Установите эту команду в планировщике задач
cronjob если хотите извлекать емейлы постоянно.
</para>
</section>


<section id="email-receiving-filter">
<title>Фильтрация/рассылка модулями OTRS/PostMaster (для более сложной
диспетчеризации)</title>

<para>
Если вы используете метод bin/otrs.PostMaster.pl или
bin/otrs.PostMasterMailbox.pl, вы можете вставить или модифицировать X-OTRS
заголовок с модулем фильтрации PostMaster. С помощью X-OTRS-заголовков,
система обработки заявок может вызывать некоторые действия для входящих
сообщений, сортировать их в определенные очереди, изменять приоритет или
ID-клиента, например. Более подробную информацию о X-OTRS-заголовках можно
найти в главе <link linkend="adminarea-postmasterpop3-account"> добавление
почтовых аккаунтов электронной почты </link> в панели управления OTRS.
</para>

<para>
Есть некоторые предустановленные модули фильтрации:
</para>

<note>
<para>
Название задания (e.g.
$Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'JobName'}) должно быть
уникальным!
</para>
</note>

<para>
Kernel::System::PostMaster::Filter::Match модуль по умолчанию для проверки
совпадения заголовков определенных емейлов (например "От", "Кому", "Тема",
...). Он может устанавливать новые заголовки email (например X-OTRS-Ignore:
да или X-OTRS-Queue: spam) если совпадают правила совпадения. Задания из
Примера 7-2 могут быть прописаны в <filename>Kernel/Config.pm</filename>
</para>

<example id='filter-module-match-example'>
<title>Пример задания для модуля фильтрации
Kernel::System::PostMaster::Filter::Match</title>

<para>
<programlisting>
    # Job Name: 1-Match
    # (block/ignore all spam email with From: noreply@)
    $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'1-Match'} = {
        Module =&gt; 'Kernel::System::PostMaster::Filter::Match',
        Match =&gt; {
            From =&gt; 'noreply@',
        },
        Set =&gt; {
            'X-OTRS-Ignore' =&gt; 'yes',
        },
    };
    # Job Name: 2-Match
    # (sort emails with From: sales@example.com and Subject: **ORDER**
    # into queue 'Order')
    $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'2-Match'} = {
        Module =&gt; 'Kernel::System::PostMaster::Filter::Match',
        Match =&gt; {
            To =&gt; 'sales@example.com',
            Subject =&gt; '**ORDER**',
        },
        Set =&gt; {
            'X-OTRS-Queue' =&gt; 'Order',
        },
    };
</programlisting>
</para>

</example>

<para>
Kernel::System::PostMaster::Filter::CMD модуль по умолчанию для получения
емейлов для внешних команд. Вывод передается в STDOUT и если результат
истинна, то устанавливается новый заголовок (например X-OTRS-Ignore: да или
X-OTRS-Queue: spam). Пример 7-3 может быть использован в
<filename>Kernel/Config.pm</filename>
</para>

<example id='filter-module-cmd-example'>
<title>Пример задания для модуля фильтрации Kernel::System::PostMaster::Filter::CMD</title>

<para>
<programlisting>
    # Job Name: 5-SpamAssassin
    # (SpamAssassin example setup, ignore spam emails)
    $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'5-SpamAssassin'} = {
        Module =&gt; 'Kernel::System::PostMaster::Filter::CMD',
        CMD =&gt; '/usr/bin/spamassassin | grep -i "X-Spam-Status: yes"',
        Set =&gt; {
            'X-OTRS-Ignore' =&gt; 'yes',
        },
    };
</programlisting>
</para>

</example>

<para>
Конечно, также есть возможность разработки своих собственных
PostMaster-модулей фильтрации.
</para>

</section>

</section>

</chapter>
