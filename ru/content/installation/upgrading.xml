<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
  "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">

<section id="upgrading">
    <title>Обновление с 3.3 до 4</title>

    <para>
    Эти инструкции предназначены для тех, кто переходит с OTRS
<emphasis>3.3</emphasis> к <emphasis>4</emphasis> или с
<emphasis>4</emphasis> к более поздним patchlevel релизам
<emphasis>4</emphasis> и применимы к обоим способам обновления из RPM и  из
исходных кодов (tarball).
    </para>

    <para>
    Если вы работаете на ранних версиях OTRS, то должны следовать такому порядку
обновления - сначала до 3.3
(1.1->1.2->1.3->2.0->2.1->2.2->2.3->2.4->3.0->3.1->3.2->3.3)! Вы должны
выполнить полное обновление до каждой версии в промежутке, включая изменения
структуры БД и perl-скриптов обновления.
    </para>

    <para>
    Помните, что если вы делаете обновление с OTRS 2.2 или более ранней, вы
должны выполнить <ulink
url="http://bugs.otrs.org/show_bug.cgi?id=6798">дополнительный шаг</ulink>.
    </para>

    <para>
    Внутри одной версии, вы можете пропустить промежуточные релизы/patch level
при обновлении. К примеру, вы можете провести обновление прямо с OTRS 4
patchlevel 2 до версии 4 patchlevel 6. Если вы желаете выполнить такое
"patch level" обновление, Вы должны пропустить шаги 6, 11, 13 и 14.
    </para>

    <para>
    Настоятельно рекомендуем выполнить сначала тестовое обновление в отдельной
тестовой среде.
    </para>

    <section role="NotInToc">
        <title>Шаг 1: Остановите все соответствующие службы</title>

        <para>
        Убедитесь, что никакие сервисы или задания cron, которые обращаются к OTRS
не выполняются. Это зависит от конфигурации вашей системы, далее приведен
пример:  <screen><![CDATA[
shell> /etc/init.d/cron stop
shell> /etc/init.d/postfix stop
shell> /etc/init.d/apache stop
            ]]></screen> Остановить OTRS cronjobs и
Планировщик (в следующем порядке): <screen><![CDATA[
shell> cd /opt/otrs/
shell> bin/Cron.sh stop
shell> bin/otrs.Scheduler.pl -a stop
            ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 2: Выполните резервное копирование содержимого папок ниже
<filename>/opt/otrs/</filename></title>

        <para>
            <itemizedlist>
                <listitem><para><filename>Kernel/Config.pm</filename></para></listitem>
                <listitem><para><filename>Kernel/Config/GenericAgent.pm</filename></para></listitem>
                <listitem><para><filename>Kernel/Config/Files/ZZZAuto.pm</filename></para></listitem>
                <listitem><para><filename>var/*</filename></para></listitem>
                <listitem><para>а также базы данных</para></listitem>
            </itemizedlist>
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 3: Убедитесь, что вы создали резервную копию всех данных ;-)</title>
        <para></para>
    </section>

    <section role="NotInToc">
    <title>Шаг 4: Установите новую версию/релиз (из tar-архива или с помощью
RPM-пакетов).</title>

        <section role="NotInToc">
        <title>Шаг 4.1: С помощью tarball:</title>

            <screen><![CDATA[
shell> cd /opt
shell> mv otrs otrs-old
shell> tar -xzf otrs-x.x.x.tar.gz
shell> mv otrs-x.x.x otrs
            ]]></screen>

            <section role="NotInToc">
            <title>Восстановить старые конфигурационные файлы</title>

                <para>
                    <itemizedlist>
                        <listitem><para><filename>Kernel/Config.pm</filename></para></listitem>
                        <listitem><para><filename>Kernel/Config/GenericAgent.pm</filename></para></listitem>
                        <listitem><para><filename>Kernel/Config/Files/ZZZAuto.pm</filename></para></listitem>
                    </itemizedlist>
                </para>
            </section>

            <section role="NotInToc">
                <title>Восстановить TicketCounter.log</title>

                <para>
                    Чтобы после обновления OTRS продолжил нумеровать заявки правильно,
восстановите <filename>TicketCounter.log</filename> в
<filename>/opt/otrs/var/log/</filename>. Это особенно важно, если вы
используете последовательную нумерацию заявок.
                </para>
            </section>

            <section role="NotInToc">
                <title>Восстановить данные статьи</title>

                <para>
                    Если вы настроили хранение данных сообщений/заметок в OTRS в файловой
системе нужно восстановить <filename>article</filename> папку в
<filename>/opt/otrs/var/</filename>.
                </para>
            </section>

            <section role="NotInToc">
                <title>Установка прав доступа к файлам.</title>

                <para>
                Выполните  <screen><![CDATA[
shell> cd /opt/otrs/
shell> bin/otrs.SetPermissions.pl
                ]]></screen>  с необходимыми для вашей
системы правами. Например:

                <itemizedlist>
                <listitem>
                    <para>Web server работающий как пользователь OTRS: <screen><![CDATA[
shell> bin/otrs.SetPermissions.pl --web-group=otrs
                ]]></screen>
                    </para>
                </listitem>


                <listitem>
                    <para>Webserver с пользователем wwwrun (например в SUSE): <screen><![CDATA[
shell> bin/otrs.SetPermissions.pl --web-group=wwwrun
                ]]></screen>
                    </para>
                </listitem>


                <listitem>
                    <para>Webserver с пользователем apache (например, Red Hat, CentOS): <screen><![CDATA[
shell> bin/otrs.SetPermissions.pl --web-group=apache
                ]]></screen>
                    </para>
                </listitem>


                <listitem>
                    <para>Webserver с пользователем www-data (например, Debian, Ubuntu): <screen><![CDATA[
shell> bin/otrs.SetPermissions.pl --web-group=www-data
                ]]></screen>
                    </para>
                </listitem>
                </itemizedlist>

                </para>
            </section>
        </section>

        <section role="NotInToc">
            <title>Шаг 4.2: С помощью RPM:</title>
            <para>
            <screen><![CDATA[
shell> rpm -Uvh otrs-x.x.x.-01.rpm
            ]]></screen> В этом случае обновление из RPM
автоматически восстанавливает старые конфигурационные файлы и устанавливает
нужные права на файлы.
            </para>
        </section>
    </section>

    <section role="NotInToc">
        <title>Шаг 5: Проверка требуемых Perl модулей</title>

        <para>
        Проверьте наличие всех требуемых perl модулей и доустановите те, которые
могли быть пропущены по разным причинам.  <screen><![CDATA[
shell> /opt/otrs/bin/otrs.CheckModules.pl
        ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 6: Применение обновлений базы данных</title>

        <section role="NotInToc">
            <title>Шаг 6.1: Схема обновления БД</title>

            <section role="NotInToc">
            <title>MySQL:</title>

                <para>
                Примечание: новые таблицы, созданные в процессе MySQL UPGRADING будут
созданы с методом доступа по умолчанию, установленном в вашем MySQL
сервере. В MySQL 5.5 применяется новый метод - <code>InnoDB</code>. Если
существующие таблицы, например, "users", имеют метод доступа, например,
<code>MyISAM</code>, может появиться сообщение об ошибке при создании
внешних ключей.
                </para>

                <para>
                Имеется два варианта: вы можете изменить стандартный метод доступа MySQL
обратно в <code>MyISAM</code>, при этом новые таблицы будут иметь тот же
метод, что и старые, или перенастроить существующие таблицы на использование
InnoDB.
                </para>

                <para>
                Любые проблемы, связанные с использованием метода доступа будут отражены в
отчете скрипта <filename>otrs.CheckDB.pl</filename>. Выполните его для
обнаружения возможных проблем. <screen><![CDATA[
shell> cd /opt/otrs/
shell> bin/otrs.CheckDB.pl
shell> cat scripts/DBUpdate-to-4.mysql.sql | mysql -p -f -u root otrs
                ]]></screen>

                </para>

            </section>
            <section role="NotInToc">
                <title>PostgreSQL:</title>

                <para>
                <screen><![CDATA[
shell> cd /opt/otrs/
shell> cat scripts/DBUpdate-to-4.postgresql.sql | psql --set ON_ERROR_STOP=on --single-transaction otrs otrs
                ]]></screen>
                </para>
            </section>
        </section>

        <section role="NotInToc">
            <title>Шаг 6.2: Скрипт миграции БД</title>

            <para>
            Выполните скрипт для миграции (как пользователь <code>otrs</code>, НЕ как
<code>root</code>): <screen><![CDATA[
shell> scripts/DBUpdate-to-4.pl
            ]]></screen> Не продолжайте
процесс обновления, если этот скрипт отрабатывает неправильно, по вашему
мнению. Иначе, вы можете потерять данные.
            </para>
        </section>
    </section>

    <section role="NotInToc">
        <title>Шаг 7: Собственные темы</title>

        <para>
        Примечание: Темы OTRS 3.3  и OTRS 4 НЕ совместимы между собой, так что не
используйте старые темы!
        </para>

        <para>
        Темы расположены в <filename>/opt/otrs/Kernel/Output/HTML/*/*.tt</filename>.
        </para>

        <para>
        Обращаем внимание, что OTRS 4 теперь использует новый механизм шаблонов
основанный на <ulink
url="http://www.template-toolkit.org">Template::Toolkit</ulink>. Все
кастомизированные шаблоны должны быть преобразованы из DTL в новый
формат. Читайте <ulink
url="http://otrs.github.io/doc/manual/developer/4.0/en/html/package-porting.html#package-porting-template-engine">Руководство
разработчика</ulink> для детальных пояснений.
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 8: Обновление конфигурации кэша и удаления данных кэшей.</title>

        <para>
         Выполните (как пользователь <code>otrs</code>, <emphasis>не</emphasis> как
<code>root</code>): <screen><![CDATA[
shell> bin/otrs.RebuildConfig.pl
shell> bin/otrs.DeleteCache.pl
        ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 9: Перезапустите сервисы</title>

        <para>
        в т.ч. (зависящие от использующихся услуг): <screen><![CDATA[
shell> /etc/init.d/apache start
shell> /etc/init.d/postfix start
shell> /etc/init.d/cron start
        ]]></screen> Теперь вы можете войти в систему.
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 10: Проверьте установленные пакеты</title>

        <note>
            <para>
                Пакеты OTRS от 3.3 НЕ совместимы с OTRS 4, поэтому надо переустановить
обновленные пакеты!
            </para>
        </note>

        <para>
        Следующие пакеты будут автоматически деинсталлированы после процесса
обновления (если были установлены ранее):

            <itemizedlist>
                <listitem><para>OTRSGenericInterfaceREST</para></listitem>
                <listitem><para>OTRSMyServices</para></listitem>
                <listitem><para>OTRSStatsRestrictionByDateTimeDF</para></listitem>
                <listitem><para>Поддержка</para></listitem>
            </itemizedlist>
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 11: Проверьте задания Планировщика задач/GenericAgent </title>

        <para>
            Если у вас имеются задания GenericAgent/Планировщика задач (или, даже
какие-то собственные разработки), которые автоматически устанавливают
значения динамических полей ProcessID или ActivityID, необходимо обновить
установку этих полей в новый формат long EntityIDs, которые генерируются
скриптом <filename>DBUpdate-to-4.pl</filename>.
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 12: Обновление и активация планировщика задач cronjobs</title>

        <para>
            В OTRS есть несколько стандартных заданий cron в файле
<filename>/opt/otrs/var/cron/*.dist</filename>. Для их применения скопируйте
их в файл, опустив в окончании его имени расширение ".dist". Выполните это,
чтобы быть уверенным в том, что вы используете последние версии заданий cron
и вновь включенные задания. <screen><![CDATA[
shell> cd /opt/otrs/var/cron
shell> for foo in *.dist; do cp $foo `basename $foo .dist`; done
            ]]></screen> Проверьте
скопированные файлы и сделайте нужные изменения, которые вы, возможно
делали. Для применения этих cronjobs в вашей системе можно использовать
скрипт <filename>Cron.sh</filename>. Убедитесь, что вы запускаете от имени
пользователя <code>otrs</code>! <screen><![CDATA[
shell> /opt/otrs/bin/Cron.sh start
            ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 13: Обновление конфигурации баз данных клиентов</title>

        <para>
        Если вы используете внешние БД клиентов и эти базы НЕ предоставляют
определенных для OTRS полей  create_time, create_by, change_time и
change_by, установите значение <code>ForeignDB => 1</code> для
<code>$Self->{CustomerUser}</code> и <code>$Self->{CustomerCompany}</code>
(см. <filename>Kernel/Config/Defaults.pm</filename>).
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 14: Перестройка индексов заявок</title>

        <para>
        Выполните <filename>bin/otrs.RebuildTicketIndex.pl</filename> для обновления
индексов заявок. Это можно сделать в фоновом режиме для пересчета номеров
заявок для экранов обзора очередей. Теперь можно пользоваться системой.
        </para>
    </section>

    <section role="NotInToc">
        <title>Шаг 14: Браво, процесс закончен!</title>
        <para></para>
    </section>

</section>
