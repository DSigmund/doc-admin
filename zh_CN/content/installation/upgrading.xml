<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
  "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">

<section id="upgrading">
    <title>Upgrading OTRS from 5 to 6</title>

    <para>
    These instructions are for people upgrading OTRS from <emphasis>5</emphasis>
to <emphasis>6</emphasis> or from a <emphasis>5</emphasis> to a later
patchlevel release <emphasis>5</emphasis> and applies both for RPM and
source code (tarball) upgrades.
    </para>

    <para>
    If you are running a lower version of OTRS you have to follow the upgrade
path to 5 first
(1.1->1.2->1.3->2.0->2.1->2.2->2.3->2.4->3.0->3.1->3.2->3.3->4->5)! You need
to perform a full upgrade to every version in between, including database
changes and the upgrading Perl script.
    </para>

    <para>
    请注意：如果你从OTRS 2.2之前的版本升级，还需要参照<ulink
url="http://bugs.otrs.org/show_bug.cgi?id=6798">执行额外的步骤</ulink>。
    </para>

    <para>
    Within a single minor version you can skip patch level releases if you want
to upgrade. For instance you can upgrade directly from OTRS 6 patchlevel 2
to version 6 patchlevel 6. If you need to do such a "patch level upgrade",
you should skip steps 6 and XXXXX.
    </para>

    <warning>
        <para>
            Please note that you need at least Perl 5.16 to run OTRS 6. If your system
has an older Perl version, you need to update it first before updating OTRS.
        </para>
    </warning>

    <warning>
        <para>
            For PostgreSQL based installations: please note that you need at least
PostgreSQL 9.2 to run OTRS 6. If your system has an older PostgreSQL
version, you need to update it first before updating OTRS.
        </para>
    </warning>

    <para>
        强烈建议在一台独立的测试主机上先进行升级测试。
    </para>

    <section role="NotInToc">
        <title>步骤1：停止所有相关的服务</title>

        <para>
        请确保没有任何运行中的服务或CRON计划任务还在试图访问OTRS。取决于你的服务配置，下面是一个例子：
        </para>

        <para>
            <screen><![CDATA[
shell> /etc/init.d/cron stop
shell> /etc/init.d/postfix stop
shell> /etc/init.d/apache stop
            ]]></screen>
        </para>

        <para>
        Stop OTRS cron jobs and the daemon (in this order):
        </para>

        <para>
            <screen><![CDATA[
shell> cd /opt/otrs/
shell> bin/Cron.sh stop
shell> bin/otrs.Daemon.pl stop
            ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 2: Backup files and database</title>

        <para>
            <itemizedlist>
                <listitem><para><filename>Kernel/Config.pm</filename></para></listitem>
                <listitem><para><filename>Kernel/Config/Files/ZZZAuto.pm</filename></para></listitem>
                <listitem><para><filename>var/*</filename></para></listitem>
                <listitem><para>当然还有数据库</para></listitem>
            </itemizedlist>
        </para>
        <warning>
            <para>Don't proceed without a complete backup of your system.</para>
        </warning>
    </section>

    <section role="NotInToc">
    <title>Step 3: Install the new release (tar or RPM)</title>

        <section role="NotInToc">
        <title>Step 3.1: With the tarball:</title>

            <screen><![CDATA[
shell> cd /opt
shell> mv otrs otrs-old
shell> tar -xzf otrs-x.x.x.tar.gz
shell> mv otrs-x.x.x otrs
            ]]></screen>

            <section role="NotInToc">
            <title>恢复原配置文件</title>

                <para>
                    <itemizedlist>
                        <listitem><para><filename>Kernel/Config.pm</filename></para></listitem>
                        <listitem><para><filename>Kernel/Config/Files/ZZZAuto.pm</filename></para></listitem>
                    </itemizedlist>
                </para>
            </section>

            <section role="NotInToc">
                <title>恢复工单数据</title>

                <para>
                    如果你配置OTRS将信件数据存储在文件系统，你必须恢复<filename>article</filename>目录到<filename>/opt/otrs/var/</filename>或在系统配置中指定的目录。
                </para>
            </section>


            <section role="NotInToc">
                <title>Restore already installed default statistics</title>

                <para>
                    If you have additional packages with default statistics you have to restore
the stats xml files with the suffix <filename>*.installed</filename> to
<filename>/opt/otrs/var/stats</filename>.
                </para>
                <screen><![CDATA[
shell> cd OTRS-BACKUP/var/stats
shell> cp *.installed /opt/otrs/var/stats
                ]]></screen>
            </section>

            <section role="NotInToc">
                <title>设置文件权限</title>

                <para>
                    Please execute the following command as root user to set the file and
directory permissions for OTRS:
                </para>

                <para>
                <screen><![CDATA[
shell> cd /opt/otrs/
shell> bin/otrs.SetPermissions.pl
                ]]></screen>
                </para>

                <para>
                    It will try to detect the correct user and group settings needed for your
setup.
                </para>
            </section>
        </section>

        <section role="NotInToc">
            <title>Step 3.2: With the RPM:</title>
            <para>
            <screen><![CDATA[
shell> rpm -Uvh otrs-x.x.x.-01.rpm
            ]]></screen>
            </para>

            <para>
             在这种情况下通过RPM升级会自动恢复原配置文件并设置文件权限。
            </para>
        </section>
    </section>

    <section role="NotInToc">
        <title>Step 4: Run the migration script</title>

        <para>
            Please run the migration script (as the <literal>otrs</literal> user, NOT as
<literal>root</literal>):
        </para>

        <para>
        <screen><![CDATA[
shell> scripts/DBUpdate-to-6.pl
        ]]></screen>
        </para>

        <para>
            This script will perform many checks on your system and give you advice on
how to install missing Perl modules etc., if that is required.
        </para>

        <para>
            The migration script will ask you to set a time zone for OTRS. It is very
important that you set the correct time zone (and keep it), otherwise date
and time of data added after the upgrade (tickets, articles, etc.) will be
stored with a different time zone than your existing data, leading to
inconsistent data.  The script will suggest possible time zones based on
your previous configuration. In case you are not sure or made a mistake, you
can change the OTRS time zone after the upgrade via SysConfig setting
<literal>OTRSTimeZone</literal>.
        </para>

        <warning>
            <para>
                如果这个脚本运行不正常，请不要继续升级，否则可能丢失数据。
            </para>
        </warning>
    </section>

    <section role="NotInToc">
        <title>Step 5: Restart your services</title>

        <para>
        例如（取决于使用的服务，可能有差异）：
        </para>

        <para>
        <screen><![CDATA[
shell> /etc/init.d/apache start
shell> /etc/init.d/postfix start
shell> /etc/init.d/cron start
        ]]></screen>
        </para>

        <para>
        现有你可以登录到系统了。
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 6: Check installed packages</title>
        <note>
            <para>
                The OTRS 5 packages are NOT compatible with OTRS 6, so you have to perform a
package upgrade!
            </para>
        </note>
        <para>
            下列软件会在升级过程中自动卸载（如果之前安装了的话）：
        </para>
        <para>
            <itemizedlist>
                <listitem><para>OTRSAppointmentCalendar</para></listitem>
            </itemizedlist>

        <!--
                TODO: Verify and extend the list of merged packages.
            -->
</para>
    </section>

    <section role="NotInToc">
        <title>Step 7: Start the OTRS Daemon</title>

        <para>
            The OTRS daemon is responsible for handling any asynchronous and recurring
tasks in OTRS.  The daemon also handles all GenericAgent jobs and must be
started as the <literal>otrs</literal> user.
        </para>

        <para>
            <screen><![CDATA[
shell> /opt/otrs/bin/otrs.Daemon.pl start
            ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 8: Update and activate cron jobs</title>

        <para>
            在<filename>/opt/otrs/var/cron/*.dist</filename>有两个默认的cron文件，它们的目的是确保OTRS守护进程正常运行。它们需要复制为没有“.dist”扩展名的新文件来激活。
        </para>

        <para>
            <screen><![CDATA[
shell> cd /opt/otrs/var/cron
shell> for foo in *.dist; do cp $foo `basename $foo .dist`; done
            ]]></screen>
        </para>

        <para>
            To schedule these cron jobs on your system, you can use the script
<filename>Cron.sh</filename> as the <literal>otrs</literal> user.
        </para>

        <para>
            <screen><![CDATA[
shell> /opt/otrs/bin/Cron.sh start
            ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 9: Update system registration (optional)</title>
        <para>
            如果系统已经注册到OTRS集团，强烈推荐这个时候更新注册信息。这将在OTRS集团的记录中更新注册的版本信息及其它变化了的信息，以便从云服务中获得更准确的信息。
        </para>
        <para>
            如果你不手动更新注册信息，则会在定期连接时自动更新，但这可能是几个小时或几天后的事了，在此期间可能会从云服务得到一些错误信息比如：<emphasis
role="bold">OTRS Business Solution™</emphasis>更新。
        </para>
        <para>
            <screen><![CDATA[
shell> cd /opt/otrs/
shell> bin/otrs.Console.pl Maint::Registration::UpdateSend --force
shell> bin/otrs.Console.pl Maint::Cache::Delete
            ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 10: Well done!</title>
        <para></para>
    </section>
</section>
